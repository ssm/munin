#! /usr/bin/perl
# Automatically enables "strict", "warnings", "utf8" and
# Perl 5.10 features

use Mojolicious::Lite;
use DBI;

use Munin::Common::Defaults;

my $datafilename = "$Munin::Common::Defaults::MUNIN_DBDIR/datafile.sqlite";

get '/grp' => sub {
	my $self = shift;
	my $id = $self->param('grp_id');

	my @params = (! defined $id) ? () : ("id = ?", $id);
	$self->render(json => get_table_data("grp", @params));
};

get '/nodes' => sub {
	my $self = shift;
	my $id = $self->param('node_id');

	my @params = (! defined $id) ? () : ("id = ?", $id);
	$self->render(json => get_table_data("node", @params));
};

get '/services' => sub {
	my $self = shift;
	my $id = $self->param('service_id');

	my @params = (! defined $id) ? () : ("id = ?", $id);
	$self->render(json => get_table_data("service", @params));
};

# Start the Mojolicious command system
app->start;

sub get_table_data
{
	my ($table, $where_clause, @params) = @_;
	$where_clause = (! $where_clause) ? "" : "WHERE $where_clause";

	my $dbh = DBI->connect("dbi:SQLite:dbname=$datafilename","","") or die $DBI::errstr;

	my $sth = $dbh->prepare( "SELECT * FROM $table $where_clause");
	$sth->execute(@params);

	my $nodes = $sth->fetchall_arrayref(
		{}
		#	{ Slice => {} }, # Each row is stored as a hashref
	);

	my $sth_attr = $dbh->prepare(
		"SELECT name, value FROM $table"."_attr WHERE id = ?",
	);
	foreach my $node (@$nodes) {
		$sth_attr->execute($node->{id});
		while (my ($_name, $_value) = $sth_attr->fetchrow_array) {
			$node->{attr}{$_name} = $_value;
		}
	}

	return $nodes;
}
