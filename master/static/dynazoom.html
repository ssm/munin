<!doctype html>
<html>
<head>
	<script language="JavaScript" src="formatdate.js"></script>
	<script language="JavaScript" src="querystring.js"></script>
	<script language="JavaScript" src="dynazoom.js"></script>
	<link rel="stylesheet" href="./style-new.css" type="text/css" />
</head>
<body>
<div id="header">
	<h1><a href="/munin/"><span class="logo"></span></a> <span class="currentpage">Dynamic Graph Zoom</span></h1>
</div>
	
<div id="imagediv" style="position:relative;">
	<img id="image" />
	<div id="graphdiv">
		<div id="overlayDiv"></div>
	</div>
</div>
<div id="zoomhelp">
	Zooming is very easy.
	<ul>
		<ol>
			<li> click and drag to highlight the time range.
			<li> click inside the shaded area to zoom or outside to cancel.
		</ol>
	</ul>
</div>

<form name="myNewForm" id="myNewForm">
	<input type=submit />
<table>
	<!-- Plugin Name : "domain/hostname" -->
	<tr>
		<td>Plugin Name <em>(domain/hostname/plugin_name)</em> :</td>
		<td><input type="text" name="plugin_name" size="64" ></td>
	</tr>

	<!-- Start and stop -->
	<tr>
		<td>Start/Stop of the graph <br/>(format:2005-08-15T15:52:01+0000) <br /><em>(epoch)</em> :</td>
		<td>
			<input type="text" name="start_iso8601" size='24'> / <input type="text" name="stop_iso8601" size="24"> <input name="btnMaj" type=button value="update" /> <br />

			(<input type="text" name="start_epoch" size="10"> / <input type="text" name="stop_epoch" size="10">)
		</td>
	</tr>

	<!-- Limit fields -->
	<tr id="field_row" style="display: none;">
		<td>Limit fields to</td>
		<td id="field_list"></td>
	</tr>

	<!-- Options -->
	<tr id="option_row" style="display: none;">
		<td>Options</td>
		<td id="option_box"></td>
	</tr>

	<!-- Limit high & low -->
	<tr>
		<td>Limit low/high : (use <i>none</i> to override limit)</td>
		<td>

			<input type="text" name="lower_limit" size="10"> /  <input type="text" name="upper_limit" size="10">
		</td>
	</tr>


	<!-- Image size -->
	<tr>
		<td>Graph size (w/o legend) <em>(pixels)</em>:</td>

		<td>
			<input type="text" name="size_x" size="5"> / <input type="text" name="size_y" size="5" >
		</td>
	</tr>
	<!-- Step -->
	<tr>
		<td>Step (granularity) <em>(seconds)</em>:</td>

		<td>
			<input type="text" name="step" size="5">
		</td>
	</tr>
</table>
	<input type=hidden name="cgiurl_graph" />
	<input type=hidden name="fields" />
	<input type=submit />
	<input type=button name="btnZoomOut" value="Zoom Out x2" />
</form>

<script>

var initial_left;

// Insert values in the form
var qs = new Querystring();

var form = document.getElementById("myNewForm");
var image = document.getElementById("image");
var divOverlay = document.getElementById("overlayDiv");
var divgraph = document.getElementById("graphdiv");
var fields = qs.get("fields");
var active_fields = [];
var divbar = [];

// Hold all the original info for the graph.  The original placed these in
// the form and used those values in places it shouldn't have been used.
// size is a perfect example of this.  If the size_y is chagned, say from
// 400 to 40, the selection will only be 40 px tall instead of the actual 400
var graph = {
	offset: { // According to rrd graphv, the x/y offsets are 33,67
		  // It would be better to get this from rrd graphv
		  // dynamically.
		x: 67,	// Atleast on the systems I've installed on.
		y: 33
	},
	limit: {
		lower: qs.get("lower_limit", ""),
		upper: qs.get("upper_limit", "")
	},
	epoch: { // The values here were original, not sure why these
		 // values were chosen.
		start: (+qs.get("start_epoch", "1236561663")),
		stop: (+qs.get("stop_epoch", "1237561663"))
	},
	size: { // Changed the default of "","" to "800","400"
		x: (+qs.get("size_x", "800")),
		y: (+qs.get("size_y", "400"))
	},
	step: qs.get("step", "")
};

// Array of options.  Each option will have a checkbox added to the element
// named option_box.  If atleast 1 option is available, the option_row will
// be visible.
var options = [{
	// CGI query string.
	qs: {
		// Parameter name passed to dynazoom.html.  Option is created
		// if this is a true value (eg 1)
		html: "hastotal",
		// Parameter name to be passed to munin-graph cgi.
		// This will also be the name of the checkbox in the form.
		graph: "nototal",
		// Value if option is checked.
		// checked: ,
		// Value if option not checked.
		unchecked: "1",
		// NOTE: if checked or unchecked is not defined, parameter
		// will not be passed depending on the checkbox status.
		// This is the default when there is no matching parameter
		// passed to the .html with the same name as the graph value
		// above.  (This case it is "nototal")
		def: true,
	},
	label: "Graph total",
	// init is called when the checkbox is created.
	// The checkbox object is passed as the parameter.
	// Not required.
	init: init_graph_total,
},{
	qs: {
		html: "hasstack",
		graph: "nostack",
		checked: "1",
		def: false,
	},
	label: "Disable stacking",
},{
	qs: {
		html: "hasarea",
		graph: "force_line",
		checked: "1",
		def: false,
	},
	label: "Force all area fields to a line",
}];

var fieldtr = document.getElementById("field_row");
var optiontr = document.getElementById("option_row");

form.cgiurl_graph.value = qs.get("cgiurl_graph", "/munin-cgi/munin-cgi-graph");
form.plugin_name.value = qs.get("plugin_name", "localdomain/localhost.localdomain/if_eth0");
form.start_epoch.value = graph.epoch.start;
form.stop_epoch.value = graph.epoch.stop;
form.lower_limit.value = graph.limit.lower;
form.upper_limit.value = graph.limit.upper;
form.size_x.value = graph.size.x;
form.size_y.value = graph.size.y;
form.step.value = graph.step;

form.btnMaj.onclick = majDates;
form.btnZoomOut.onclick = zoomOut;

init_field_list();
init_options(options, "option_row", "option_box");

// Refresh the image with the selected params
var scale = refreshImg();

updateStartStop();

// When scale is 1 or less, each pixel in the graph image = 1 second or less.
// Millisecond graphs are not possible with munin.  Even less than 300 is not
// trivial as I understand it.
if (scale > 1)
{
	// Set the handlers.
	divgraph.onmousedown = dragstart;
	// Clear these.  dragstart will setup anything needed.
	divgraph.onmousemove = null;
	divgraph.onmouseup = null;
	divgraph.onclick = null;
}
else
	// setup the graph click to this function.  Alert the user once that
	// the operation is not permitted.
	divgraph.onclick = function ()
	{
		alert("Already at maximum zoom.\n" +
			"Each pixel is " + scale.toPrecision(3) + " seconds"
		);
		// Alert only once.
		divgraph.onclick = null;
	}

</script>

<style>
#overlayDiv {
	opacity: .55;
	filter: alpha(opacity=55);
	background-color:#EEE;
	position: absolute;
	z-index: 3;
}

#graphdiv {
	background-color: rgba(0,0,0,0);
	position: absolute;
	background-image: url(file:///);
	left: 0px;
	z-index: 2;
}

#zoomhelp ul ol {
	margin: 0px;
	padding: 0px;
}

#zoomhelp ul {
	margin: 5px;
	padding: 0px 0px 0px 3em;
}

#zoomhelp {
	padding-left: 1em;
}

</style>


</body>
</html>
